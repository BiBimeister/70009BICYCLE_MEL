<!DOCTYPE html>
<html>
<head>
	<title>Bicycles</title>

	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!--Bootstrap CSS-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

	<!--Google Font CSS-->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Teko">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Questrial">
	
	<!--Website CSS-->
	<link rel="stylesheet" href="styles.css">
	<link rel="stylesheet" href="letter.css">
	<link rel="stylesheet" href="tooltip.css">
	<!--Website Js-->
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/easing.js"></script>
	<script type="text/javascript" src="js/move-top.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script> <!--letter-->

	<!-- Mapbox CSS -->
	<link rel="stylesheet" href="mapbox.css">
	<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
	<!-- Mapbox Js-->
	<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
	<script src="mapbox-gl-compare.js"></script>
	<!-- Mapbox Compare -->
	<link
		rel="stylesheet"
		href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.css"
		type="text/css"
	/>

	<!-- Turf Js -->
	<script src='https://api.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>

	<!-- Data Js -->
	<script language=javascript src='./data.js'></script>

	
	<link rel="stylesheet" href="fwslider.css" media="all">
	<script src="js/jquery-ui.min.js"></script>
	<script src="js/css3-mediaqueries.js"></script>
	<script src="js/fwslider.js"></script>
	
</head>
<body>

<!--1st Screen-->
<div id="screen1">
	<div class="mask">
	
	<!--Title & Menu-->
	<div class="container-fluid navbar1">
		<div class="row">
			<div class="col-sm-1"><img src="Images/BicycleLogo.png" alt="Logo" width="120px" height="120px"></div>
			<div class="col-sm-8"> 
				<div id="main-title" class="ml10">
				<span class="text-wrapper">
				<span class="letters" style="color: #375511"> Let's Bicycle! </span></span>
				</div>
				<div id="group-mem-names">Melbourne Bicycle Guide in 2020</div>
				</div>	
			<div class="col-sm-3" class="weather-wdiget">
<a class="weatherwidget-io" href="https://forecast7.com/en/n37d81144d96/melbourne/" data-font="Fira Sans" data-icons="Climacons Animated" data-days="3" data-theme="beige" data-basecolor="#899a87" data-textcolor="#f1eee5" data-highcolor="#f1eee5" data-lowcolor="#f1eee5" data-suncolor="#f3d07b" data-mooncolor="#f1eee5" data-cloudcolor="#f1eee5" data-raincolor="#f1eee5" data-snowcolor="#f1eee5" >MELBOURNE WEATHER</a>
<script>
!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='https://weatherwidget.io/js/widget.min.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','weatherwidget-io-js');
</script>
				</div>		
			</div>
		</div>
		
		<div class="row" id="menu-bar" class="navbar-fixed-top">
			<div class="col-sm-2"></div>
			<div class="col-3 menu-items"><a href="#menu-bar" class="scroll"> Home </a></div>
			<div class="col-3 menu-items"><a href="#screen2" class="scroll"> Map </a></div>
			<div class="col-3 menu-items"><a href="#screen3" class="scroll"> Report </a></div>
			<div class="col-1"></div>
		</div>
	</div>
	
	<!--After Menu-->
	<div class="nav-container">
	<div class="container-fluid">
		<div class="row" style="margin-top: 25px">		
			<div class="col-sm-1"></div>
			<div class="col-8"> <span class="title-design"> Explore Cycling in Melbourne </span></div>
			<div class="col-3"></div>
		</div>
		<div class="row" style="margin-top: 20px">	
			<div class="col-sm-1"></div>
			<div class="col-sm-5 ana-text">In March 2017, bicycles made up <font size="5" color="#e6e6e6" >16%</font> of all vehicle movements into the city in the morning peak period (between 7am and 10am). 
			In March 2008 the figure was <font size="5" color="#e6e6e6" >9%</font>. On key routes bicycles made up a significant percentage of all vehicles entering the central city in the one-hour morning peak (8am to 9am). 
			Number and percentage of bikes entering the central city from 8am to 9am, March 2017.</div>
			<div class="col-sm-5 ana-viz">Some viz</div>
			<div class="col-sm-1"></div>
		</div>
	</div>
	</div>
	</div>
</div>

<!--1.5 Screen Slider-->
<div id="screen1-5">		
		<!----start-images-slider---->
		<div class="col-sm-12" class="images-slider">
			<!-- start slider -->
		    <div id="fwslider">
		        <div class="slider_container">
		            <div class="slide"> 
					<img src="Images/slideimage0.jpg" alt=""/>
		            </div>
		            <!-- /Duplicate to create more slides -->
		            <div class="slide">
		            <img src="Images/slideimage1.jpg" alt=""/>
		            </div>
		            <div class="slide">
		            <img src="Images/slideimage2.jpg" alt=""/>		               
		            </div>
		            <!--/slide -->
		        </div>
		        <div class="timers"> </div>
		        <div class="slidePrev"><span> </span></div>
		        <div class="slideNext"><span> </span></div>
		    </div>
		    
</div>
	<div class="container-fluid">		
	</div>
</div>

<!--2nd Screen MAP-->
<div id="screen2">
	<div class="mapbox-wrapper">
	<div class="title-design">
			<div class="col-sm-12"> MAP </div>			
	</div>
	<div id="comparison-container">
		<div id="before-map" class="map"></div>
		<div id="after-map" class="map"></div>
	</div>
	<div id="map-menu"></div>
	<div id="map-feature"></div>
	<div id="featureType" style="visibility: hidden;"> -1 </div>
	</div>
</div>

<!--3rd Screen Report-->
<div id="screen3">
	<div class="container-fluid" style="padding: 0px">
		<div class="title-design">
			<div class="col-sm-12"> The Stats! </div>			
		</div>		
	</div>
</div>

<div id="footer">

		<div class="container-fluid">
		<div class="row">
 			<div class="col-md-12">	
				<div class="footer-info">
					<p>GEOM90007 GROUP 26</p>
					<p> Mingdong XU | Tiana Chimbaikar | Tianzhi Li | Xianxhe Tong | Zhiyuan Shen </p>	
				</div>
				<hr />
				<div class="copy-right">
				<span>Copyright &copy; 2020-2021. The University of Melbourne</span>
				</div>
			</div>
		</div>
    </div>
</div>


<div id="about-us" style="display: block;"><span style="opacity: 1;"></span></div>
<a href="#" id="toTop" style="display: block;"><span id="toTopHover" style="opacity: 1;"></span></a>

	<!--Scripts-->
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/easing.js"></script>
	<script type="text/javascript" src="js/move-top.js"></script>
	<script type="text/javascript" src="js/jquery.cslider.js"></script>
	<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>


 <!-- scroll_top_botton -->	
	<script type="text/javascript">
			$(document).ready(function() {
			
				var defaults = {
		  			containerID: 'toTop', // fading element id
					containerHoverID: 'toTopHover', // fading element hover id
					scrollSpeed: 1200,
					easingType: 'linear' 
		 		};
				
				
				$().UItoTop({ easingType: 'easeOutQuart' });
				
			});
	</script> 
	
<!--scroll smooth-->
	<script type="text/javascript">
		jQuery(document).ready(function($) {
			$(".scroll").click(function(event){		
				event.preventDefault();
				$('html,body').animate({scrollTop:$(this.hash).offset().top},1200);
			});
		});
	</script>

<!--title animation-->
	<script type="text/javascript">
	var textWrapper = document.querySelector('.ml10 .letters');
	textWrapper.innerHTML = textWrapper.textContent.replace(/\S/g, "<span class='letter'>$&</span>");

	anime.timeline({loop: true})
	  .add({
		targets: '.ml10 .letter',
		rotateY: [-90, 0],
		duration: 1300,
		delay: (el, i) => 60 * i
	  }).add({
		targets: '.ml10',
		opacity: 0,
		duration: 1000,
		easing: "easeOutExpo",
		delay: 1000
	  });
	</script>

<!-- mapbox part-->
	<script type="text/javascript">

		function getRoute(start, end) {
			// make a directions request using cycling profile
			// an arbitrary start will always be the same
			// only the end or destination will change
			var url = 'https://api.mapbox.com/directions/v5/mapbox/cycling/' + start[0] + ',' + start[1] + ';' + end[0] + ',' + end[1] + '?steps=true&geometries=geojson&access_token=' + mapboxgl.accessToken;

			// make an XHR request https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest
			var req = new XMLHttpRequest();
			req.open('GET', url, true);
			req.onload = function() {
				var json = JSON.parse(req.response);
				var data = json.routes[0];
				var route = data.geometry.coordinates;
				var geojson = {
					type: 'Feature',
					properties: {},
					geometry: {
						type: 'LineString',
						coordinates: route
					}
				};
				beforeMap.getSource('route').setData(geojson);
			};
			req.send();
		}
	
		mapboxgl.accessToken = 'pk.eyJ1IjoidGlhbnpoaXBlbmdmZWkiLCJhIjoiY2tleHNiZnFqMzJiMDJxbGdtb3cxdnZjNCJ9.y_c9Bp7uXK3tQvaCrp3kCw';
		
		var beforeMap = new mapboxgl.Map({
			container: 'before-map',
			style: 'mapbox://styles/tianzhipengfei/ckgnja5mz050t19nyuqxao4gp',
			zoom: 14,
			center: [144.955184, -37.832555]
		});

		var afterMap = new mapboxgl.Map({
			container: 'after-map',
			style: 'mapbox://styles/tianzhipengfei/ckgp7nfvc2gz21aqp4xo928mt',
			zoom: 14,
			center: [144.955184, -37.832555]
		});

		var container = '#comparison-container';

		var map = new mapboxgl.Compare(beforeMap, afterMap, container, {
			// Set this to enable comparing two maps by mouse movement:
			// mousemove: true
		});

		beforeMap.on('load', function() {

			beforeMap.loadImage('http://tianzhipengfei.xin/static/cycle.png', (error, image) => {
				if (error) throw error;
				beforeMap.addImage('dock_image', image);
			});

			beforeMap.loadImage('http://tianzhipengfei.xin/static/placeholder.png', (error, image) => {
				if (error) throw error;
				beforeMap.addImage('park_image', image);
			});

			beforeMap.loadImage('http://tianzhipengfei.xin/static/shopping.png', (error, image) => {
				if (error) throw error;
				beforeMap.addImage('shop_image', image);
			});

			beforeMap.addSource('nearest-location', {
				type: 'geojson',
				data: {
				type: 'FeatureCollection',
				features: []
				}
			});

			beforeMap.addSource('route', {
				type: 'geojson',
				data: {
					type: 'Feature',
					properties: {},
					geometry: {
					type: 'LineString',
					coordinates: []
					}
				}
			});
			beforeMap.addLayer({
				id: 'route',
				type: 'line',
				source: 'route',
				layout: {
					'line-join': 'round',
					'line-cap': 'round',
					'visibility': 'visible'
				},
				paint: {
					'line-color': '#3887be',
					'line-width': 5,
					'line-opacity': 0.75
				}
			});

			// add source and layer for bicycle stops
			beforeMap.addSource('stops', stopData);
			beforeMap.addLayer({
				'id': 'stops',
				'type': 'symbol',
				'source': 'stops',
				'layout': {
						// make layer visible by default
						'visibility': 'visible',
						'icon-image': 'park_image',
						'icon-size': 0.3
					}
				});

			// add source and layer for bicycle shops
			beforeMap.addSource('shops', shopData);
			beforeMap.addLayer({
				'id': 'shops',
				'type': 'symbol',
				'source': 'shops',
				'layout': {
					// make layer visible by default
					'visibility': 'visible',
						'icon-image': 'shop_image',
						'icon-size': 0.45
				}
			});

			// add source and layer for bicycle shared docks
			beforeMap.addSource('docks', dockData);
			beforeMap.addLayer({
				'id': 'docks',
				'type': 'symbol',
				'source': 'docks',
				'layout': {
					// make layer visible by default
					'visibility': 'visible',
						'icon-image': 'dock_image',
						'icon-size': 0.45
				}
			});

			// map.addSource('crashes',{
			// 	type:'vector',
			// 	url:'mapbox://tianzhipengfei.cvhxe4pc'
			// })

			// map.addLayer({
			// 	'id':'day_crashes',
			// 	'type':'circle',
			// 	'source':'crashes',
			// 	'source-layer':'Crashes_mingdong-21jy40',
			// 	layout:{
			// 		visibility:'visible'
			// 	},
			// 	'filter':[
			// 		'all',
			// 		['!=','Bicyclist',0],
			// 		['==','Light Condition','Day'||'Dusk/Dawn']
			// 	],
			// 	"paint":{
			// 		"circle-color":"#e33b3b",
			// 		"circle-radius":3,
			// 		"circle-opacity":0.8
			// 	}
			// })

			// map.addLayer({
			// 	'id':'night_crashes',
			// 	'type':'circle',
			// 	'source':'crashes',
			// 	'source-layer':'Crashes_mingdong-21jy40',
			// 	layout:{
			// 		visibility:'visible'
			// 	},
			// 	'filter':[
			// 		'all',
			// 		['!=','Bicyclist',0],
			// 		['!=','Light Condition','Day'||'Dusk/Dawn']
			// 	],
			// 	"paint":{
			// 		"circle-color":"#0f77ff",
			// 		"circle-radius":3,
			// 		"circle-opacity":0.8
			// 	}
			// });

			// enumerate ids of the layers
			// var toggleableLayerIds = ['stops', 'volume', 'shops', 'docks', 'day_crashes', 'night_crashes'];
			var toggleableLayerIds = ['Stops', 'Shops', 'Public bicycle'];
			var featuresLayerIds = ['Nearest Stop', 'Nearest Shop', 'Nearest Public bicycle']


			// Add geolocate control to the map.
			var geolocate = new mapboxgl.GeolocateControl({
				positionOptions: {
					enableHighAccuracy: true
				},
				trackUserLocation: false
			});

			// Add the control to the map.
			beforeMap.addControl(geolocate);

			// Set an event listener that fires
			// when a geolocate event occurs.
			geolocate.on('geolocate', function(position) {
				const latitude = position.coords.latitude;
				const longitude = position.coords.longitude;
				let curPoint = [longitude, latitude]
				var featureType = document.getElementById('featureType').value;
				console.log(featureType)
				if(featureType == -1){
					beforeMap.getSource('nearest-location').setData({
						type: 'FeatureCollection',
						features: []
					});
					beforeMap.getSource('route').setData({
						type: 'FeatureCollection',
						features: []
					});
					return 
				}	
				document.getElementById('featureType').value = -1

				map.setSlider(10000)
				var data = null
				var origin_layer = null
				// find nearest stops 
				if(featureType == "Nearest Stop"){
					data = beforeMap.getSource("stops").serialize();
					origin_layer = "stops"
				}
				// find nearest shop 
				else if(featureType == "Nearest Shop"){
					data = beforeMap.getSource("shops").serialize();
					origin_layer = "shops"
				}
				// find nearest public bicycle 
				else if(featureType == "Nearest Public bicycle"){
					data = beforeMap.getSource("docks").serialize();
					origin_layer = "docks"
				}
				var point = {
					"type": "Feature",
					"properties": {
						"marker-color": "#0f0"
					},
					"geometry": {
						"type": "Point",
						"coordinates": curPoint
					}
				};
				var candidates = data.data
				var nearestLocation = turf.nearest(point, candidates);
				if (nearestLocation !== null) {
					// Update the 'nearest-location' data source to include
					// the nearest location

					var mapLayer = beforeMap.getLayer('nearest-location');
					if(typeof(mapLayer) !== 'undefined') {
					// Remove map layer 
						beforeMap.removeLayer('nearest-location')
					}

					beforeMap.getSource('nearest-location').setData({
						type: 'FeatureCollection',
						features: [
							nearestLocation
						]
					});

					// Create a new circle layer from the 'nearest-library' data source
					beforeMap.addLayer({
						id: 'nearest-location',
						type: 'circle',
						source: 'nearest-location',
						paint: {
							'circle-radius': 20,
							'circle-color': '#486DE0'
						}
					}, origin_layer);
					let targetPoint = nearestLocation.geometry.coordinates
					getRoute(curPoint, targetPoint);
				}
			});

			// set up the corresponding toggle button for each layer
			for (var i = 0; i < toggleableLayerIds.length; i++) {
				var id = toggleableLayerIds[i];

				var link = document.createElement('a');
				link.href = '#';
				link.className = 'active';
				link.textContent = id;

				link.onclick = function(e) {
					var clickedLayer = this.textContent;
					['Stops', 'Shops', 'Public bicycle'];
					if(clickedLayer == 'Stops'){
						clickedLayer = 'stops'
					} else if(clickedLayer == 'Shops'){
						clickedLayer = 'shops'
					}  else if(clickedLayer == 'Public bicycle'){
						clickedLayer = 'docks'
					} 
					e.preventDefault();
					e.stopPropagation();

					var visibility = beforeMap.getLayoutProperty(clickedLayer, 'visibility');
					

					// toggle layer visibility by changing the layout object's visibility property
					if (visibility === 'visible') {
						beforeMap.setLayoutProperty(clickedLayer, 'visibility', 'none');
						this.className = '';
					} else {
						this.className = 'active';
						beforeMap.setLayoutProperty(clickedLayer, 'visibility', 'visible');
					}
				}
				var layers = document.getElementById('map-menu');
				layers.appendChild(link);
			}

			for (var i = 0; i < featuresLayerIds.length; i++) {
				var id = featuresLayerIds[i];
			
				var link = document.createElement('a');
				link.className = 'active';
				link.textContent = id;

				link.onclick = function(e) {
					var targetType = document.getElementById('featureType').value = e.srcElement.outerText
					if (targetType != -1){
						geolocate.trigger()
						return 
					}
				}
				var layers = document.getElementById('map-feature');
				layers.appendChild(link);
			}
		})
	</script>
</body>
</html>